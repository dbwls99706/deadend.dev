"""Bulk generate wave 4: +50 canons (target: 193 total).

Usage: python -m generator.bulk_generate_v4
"""

import json
from generator.bulk_generate import (
    canon, de, wa, leads, preceded, confused, DATA_DIR,
)


def get_all_canons():
    c = []

    # ── PYTHON ──────────────────────────────────────────

    c.append(canon(
        "python", "typeerror-not-callable", "py311-linux",
        "TypeError: 'int' object is not callable",
        r"TypeError: '(\w+)' object is not callable",
        "type_error", "python", ">=3.11,<3.13", "linux",
        "true", 0.95, 0.95,
        "Variable shadows a function name. Common: len = len(x) then calling len() again.",
        [de("Rename the function",
            "The function is a builtin — you shadowed it with a variable", 0.80,
            sources=["https://docs.python.org/3/library/functions.html"]),
         de("Cast the object to callable type",
            "The object is genuinely not callable — casting won't help", 0.75,
            sources=["https://docs.python.org/3/library/functions.html#callable"])],
        [wa("Find where a variable shadows the builtin/function name and rename the variable", 0.95,
            "# Bad: list = [1,2,3]; list()  →  Fix: my_list = [1,2,3]",
            sources=["https://docs.python.org/3/library/functions.html"]),
         wa("Check for missing operator: f(x)(y) might need f(x) * (y)", 0.85,
            sources=["https://docs.python.org/3/reference/expressions.html"])],
        python=">=3.11,<3.13",
    ))

    c.append(canon(
        "python", "typeerror-not-iterable", "py311-linux",
        "TypeError: 'int' object is not iterable",
        r"TypeError: '(\w+)' object is not iterable",
        "type_error", "python", ">=3.11,<3.13", "linux",
        "true", 0.95, 0.95,
        "Trying to iterate over a non-iterable. Common: for x in some_int, or sum(x) where x is not a list.",
        [de("Wrap in list() blindly",
            "Doesn't fix the root cause — the variable shouldn't be an int", 0.70,
            sources=["https://docs.python.org/3/library/functions.html#iter"]),
         de("Add __iter__ to the class",
            "Usually the variable is wrong type, not missing __iter__", 0.65,
            sources=["https://docs.python.org/3/reference/datamodel.html#object.__iter__"])],
        [wa("Check the variable type — it's probably returning a single value instead of a collection", 0.95,
            sources=["https://docs.python.org/3/library/functions.html#isinstance"]),
         wa("If you need to iterate over digits/chars, convert first: str(num) or [num]", 0.88,
            sources=["https://docs.python.org/3/library/stdtypes.html#str"])],
        python=">=3.11,<3.13",
    ))

    c.append(canon(
        "python", "stopiteration", "py311-linux",
        "StopIteration",
        r"StopIteration",
        "runtime_error", "python", ">=3.11,<3.13", "linux",
        "true", 0.90, 0.90,
        "next() called on exhausted iterator. Since PEP 479, StopIteration inside generator becomes RuntimeError.",
        [de("Catch StopIteration inside the generator",
            "PEP 479 converts this to RuntimeError — catching won't help", 0.75,
            sources=["https://peps.python.org/pep-0479/"]),
         de("Reset the iterator by reassigning",
            "Iterators can't be reset — need to create a new one", 0.70,
            sources=["https://docs.python.org/3/library/functions.html#next"])],
        [wa("Use next(iter, default) to provide a default value for exhausted iterators", 0.95,
            "val = next(my_iter, None)",
            sources=["https://docs.python.org/3/library/functions.html#next"]),
         wa("Convert to list first if you need multiple passes, or recreate the iterator", 0.90,
            sources=["https://docs.python.org/3/library/functions.html#list"])],
        python=">=3.11,<3.13",
    ))

    c.append(canon(
        "python", "assertionerror", "py311-linux",
        "AssertionError",
        r"AssertionError",
        "runtime_error", "python", ">=3.11,<3.13", "linux",
        "true", 0.90, 0.90,
        "Assert statement failed. Never use assert for data validation — it's stripped with python -O.",
        [de("Remove the assert statement",
            "Hides the bug — the assertion caught a real problem", 0.80,
            sources=["https://docs.python.org/3/reference/simple_stmts.html#the-assert-statement"]),
         de("Wrap in try/except AssertionError",
            "Silences the error but doesn't fix the cause", 0.75,
            sources=["https://docs.python.org/3/reference/simple_stmts.html#the-assert-statement"])],
        [wa("Read the assert message to understand what condition failed, then fix the data/logic", 0.95,
            sources=["https://docs.python.org/3/reference/simple_stmts.html#the-assert-statement"]),
         wa("Replace assert with proper if/raise ValueError for production validation", 0.88,
            sources=["https://docs.python.org/3/reference/simple_stmts.html#the-assert-statement"])],
        python=">=3.11,<3.13",
    ))

    c.append(canon(
        "python", "runtimeerror-dict-changed-size", "py311-linux",
        "RuntimeError: dictionary changed size during iteration",
        r"RuntimeError: dictionary changed size during iteration",
        "runtime_error", "python", ">=3.11,<3.13", "linux",
        "true", 0.95, 0.95,
        "Modifying a dict while iterating over it. Also applies to sets.",
        [de("Use try/except RuntimeError to catch and continue",
            "Silences the error but iteration results are undefined", 0.85,
            sources=["https://docs.python.org/3/library/stdtypes.html#dictionary-view-objects"]),
         de("Switch to a different dict implementation",
            "All Python dicts have this restriction", 0.70,
            sources=["https://docs.python.org/3/library/stdtypes.html#dict"])],
        [wa("Iterate over a copy: for k in list(d.keys()): del d[k]", 0.95,
            "for key in list(my_dict.keys()):\n    if condition:\n        del my_dict[key]",
            sources=["https://docs.python.org/3/library/stdtypes.html#dict"]),
         wa("Build a new dict with dict comprehension instead of modifying in place", 0.92,
            "filtered = {k: v for k, v in d.items() if condition}",
            sources=["https://docs.python.org/3/tutorial/datastructures.html#dictionaries"])],
        python=">=3.11,<3.13",
    ))

    c.append(canon(
        "python", "valueerror-not-enough-values", "py311-linux",
        "ValueError: not enough values to unpack (expected 2, got 1)",
        r"ValueError: not enough values to unpack \(expected \d+, got \d+\)",
        "value_error", "python", ">=3.11,<3.13", "linux",
        "true", 0.95, 0.95,
        "Tuple unpacking mismatch. Common in for loops over dicts without .items().",
        [de("Add * to catch remaining values",
            "Masks the real issue — wrong data shape", 0.65,
            sources=["https://docs.python.org/3/tutorial/datastructures.html#tuples-and-sequences"]),
         de("Pad the iterable with None values",
            "Doesn't fix the source of wrong-length data", 0.60,
            sources=["https://docs.python.org/3/library/itertools.html#itertools.zip_longest"])],
        [wa("Check if iterating dict — use .items() for key-value pairs", 0.95,
            "for key, value in my_dict.items():  # not: for k, v in my_dict:",
            sources=["https://docs.python.org/3/library/stdtypes.html#dict.items"]),
         wa("Print/inspect the actual data to see its shape, then fix unpacking count", 0.90,
            sources=["https://docs.python.org/3/library/functions.html#print"])],
        python=">=3.11,<3.13",
    ))

    c.append(canon(
        "python", "connectionerror-requests", "py311-linux",
        "requests.exceptions.ConnectionError: HTTPConnectionPool",
        r"(requests\.exceptions\.)?ConnectionError.*HTTPConnectionPool",
        "network_error", "python", ">=3.11,<3.13", "linux",
        "partial", 0.80, 0.85,
        "HTTP connection failed. Server down, wrong URL, firewall, or DNS resolution failure.",
        [de("Increase timeout to very large value",
            "If server is down, waiting longer won't help", 0.70,
            sources=["https://requests.readthedocs.io/en/latest/user/advanced/#timeouts"]),
         de("Disable SSL verification",
            "ConnectionError is not an SSL error — wrong fix", 0.80,
            sources=["https://requests.readthedocs.io/en/latest/user/advanced/#ssl-cert-verification"])],
        [wa("Verify the URL is correct and the server is actually running", 0.90,
            "curl -v http://localhost:8000/health",
            sources=["https://requests.readthedocs.io/en/latest/user/quickstart/"]),
         wa("Add retry logic with exponential backoff for transient failures", 0.85,
            "from urllib3.util.retry import Retry",
            sources=["https://urllib3.readthedocs.io/en/stable/reference/urllib3.util.html#urllib3.util.Retry"]),
         wa("Check firewall, proxy settings, and DNS resolution", 0.80,
            sources=["https://requests.readthedocs.io/en/latest/user/advanced/#proxies"])],
        python=">=3.11,<3.13",
    ))

    # ── NODE ──────────────────────────────────────────

    c.append(canon(
        "node", "err-http-headers-sent", "node20-linux",
        "Error [ERR_HTTP_HEADERS_SENT]: Cannot set headers after they are sent to the client",
        r"ERR_HTTP_HEADERS_SENT.*Cannot set headers after they are sent",
        "http_error", "node", ">=20,<23", "linux",
        "true", 0.92, 0.92,
        "Response already sent but code tries to send again. Missing return after res.send().",
        [de("Add res.headersSent check before every response",
            "Doesn't fix the control flow bug — just hides it", 0.75,
            sources=["https://nodejs.org/api/http.html#responseheaderssent"]),
         de("Wrap in try/catch",
            "The error is a logic bug, not an exception to catch", 0.80,
            sources=["https://nodejs.org/api/errors.html"])],
        [wa("Add return after res.send()/res.json()/res.redirect() to prevent further execution", 0.95,
            "if (error) { return res.status(400).json({ error }); }",
            sources=["https://expressjs.com/en/api.html#res.send"]),
         wa("Check for multiple middleware calling next() and also sending response", 0.88,
            sources=["https://expressjs.com/en/guide/writing-middleware.html"])],
    ))

    c.append(canon(
        "node", "maximum-call-stack", "node20-linux",
        "RangeError: Maximum call stack size exceeded",
        r"RangeError: Maximum call stack size exceeded",
        "runtime_error", "node", ">=20,<23", "linux",
        "true", 0.90, 0.90,
        "Infinite recursion or deeply nested function calls. Common in recursive algorithms without base case.",
        [de("Increase Node stack size with --stack-size",
            "Just delays the crash — infinite recursion will still overflow", 0.80,
            sources=["https://nodejs.org/api/cli.html#--stack-sizesize"]),
         de("Convert to setImmediate/setTimeout recursion",
            "May work but creates memory leaks and is very slow", 0.60,
            sources=["https://nodejs.org/api/timers.html#setimmediatecallback-args"])],
        [wa("Check recursive function for missing or incorrect base case", 0.95,
            sources=["https://developer.mozilla.org/en-US/docs/Glossary/Recursion"]),
         wa("Convert recursive algorithm to iterative with explicit stack", 0.90,
            "const stack = [initial]; while (stack.length) { const item = stack.pop(); ... }",
            sources=["https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Loops_and_iteration"]),
         wa("Check for circular references in objects being JSON.stringify'd or deep-cloned", 0.85,
            sources=["https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"])],
    ))

    c.append(canon(
        "node", "cannot-use-import", "node20-linux",
        "SyntaxError: Cannot use import statement outside a module",
        r"SyntaxError: Cannot use import statement outside a module",
        "module_error", "node", ">=20,<23", "linux",
        "true", 0.95, 0.95,
        "ES module import used in CommonJS context. Need type:module in package.json or .mjs extension.",
        [de("Change all imports to require()",
            "May break if the dependency only exports ESM", 0.60,
            sources=["https://nodejs.org/api/esm.html"]),
         de("Add babel transpilation",
            "Overkill — Node natively supports ESM", 0.65,
            sources=["https://nodejs.org/api/esm.html#enabling"])],
        [wa("Add \"type\": \"module\" to package.json", 0.95,
            '{ "type": "module" }',
            sources=["https://nodejs.org/api/packages.html#type"]),
         wa("Rename file to .mjs extension", 0.90,
            sources=["https://nodejs.org/api/esm.html#enabling"]),
         wa("Use dynamic import(): const mod = await import('module')", 0.85,
            sources=["https://nodejs.org/api/esm.html#import-expressions"])],
    ))

    c.append(canon(
        "node", "fetch-not-defined", "node18-linux",
        "ReferenceError: fetch is not defined",
        r"ReferenceError: fetch is not defined",
        "runtime_error", "node", ">=18,<23", "linux",
        "true", 0.95, 0.95,
        "fetch() is experimental in Node 18, stable in Node 21+. Common when porting browser code.",
        [de("Polyfill with whatwg-fetch",
            "whatwg-fetch is browser-only, doesn't work in Node", 0.80,
            sources=["https://nodejs.org/api/globals.html#fetch"]),
         de("Use XMLHttpRequest",
            "XMLHttpRequest doesn't exist in Node", 0.90,
            sources=["https://nodejs.org/api/globals.html"])],
        [wa("Install node-fetch: npm install node-fetch", 0.95,
            "import fetch from 'node-fetch';",
            sources=["https://www.npmjs.com/package/node-fetch"]),
         wa("Upgrade to Node 21+ where fetch is stable, or use --experimental-fetch flag in Node 18", 0.90,
            sources=["https://nodejs.org/api/globals.html#fetch"]),
         wa("Use undici (Node's built-in HTTP client): const { fetch } = require('undici')", 0.88,
            sources=["https://nodejs.org/api/globals.html#fetch"])],
    ))

    c.append(canon(
        "node", "eperm-operation-not-permitted", "node20-linux",
        "Error: EPERM: operation not permitted",
        r"Error: EPERM:? operation not permitted",
        "filesystem_error", "node", ">=20,<23", "linux",
        "partial", 0.82, 0.85,
        "File system permission denied. Common on Windows (file locked by antivirus) or Linux (root-owned files).",
        [de("Run as administrator/root",
            "Security risk — fix the permission issue instead", 0.70,
            sources=["https://nodejs.org/api/fs.html"]),
         de("Disable antivirus temporarily",
            "Unreliable and unsafe workaround", 0.80,
            sources=["https://nodejs.org/api/errors.html#common-system-errors"])],
        [wa("Check file ownership and permissions: ls -la or icacls on Windows", 0.90,
            sources=["https://nodejs.org/api/fs.html#file-system-permissions"]),
         wa("Close applications that may have the file locked (IDE, other Node processes)", 0.85,
            sources=["https://nodejs.org/api/errors.html#common-system-errors"]),
         wa("On npm install errors, delete node_modules and package-lock.json, then retry", 0.88,
            "rm -rf node_modules package-lock.json && npm install",
            sources=["https://docs.npmjs.com/cli/v10/commands/npm-install"])],
    ))

    # ── TYPESCRIPT ──────────────────────────────────────────

    c.append(canon(
        "typescript", "ts2551-did-you-mean", "ts5-linux",
        "error TS2551: Property 'X' does not exist on type 'Y'. Did you mean 'Z'?",
        r"TS2551.*Property '(.+?)' does not exist on type '(.+?)'.*Did you mean",
        "type_error", "typescript", ">=5.0,<6.0", "linux",
        "true", 0.98, 0.95,
        "Typo in property name. TypeScript suggests the correct name.",
        [de("Use (obj as any).prop to bypass",
            "Loses all type safety, the typo is the real bug", 0.85,
            sources=["https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#any"]),
         de("Add the misspelled property to the type definition",
            "Creates a duplicate/wrong property instead of fixing the typo", 0.90,
            sources=["https://www.typescriptlang.org/docs/handbook/2/objects.html"])],
        [wa("Use the suggested correct property name from the error message", 0.98,
            sources=["https://www.typescriptlang.org/docs/handbook/2/narrowing.html"]),
         wa("Use IDE autocomplete to avoid typos in property names", 0.95,
            sources=["https://www.typescriptlang.org/docs/handbook/2/objects.html"])],
    ))

    c.append(canon(
        "typescript", "ts1005-expected", "ts5-linux",
        "error TS1005: ';' expected",
        r"TS1005.*expected",
        "syntax_error", "typescript", ">=5.0,<6.0", "linux",
        "true", 0.95, 0.95,
        "Syntax error — often caused by wrong tsconfig target, unsupported syntax, or genuine typo.",
        [de("Add semicolons everywhere",
            "Often not a real missing semicolon — it's a parser confusion from other syntax issues", 0.70,
            sources=["https://www.typescriptlang.org/docs/handbook/2/basic-types.html"]),
         de("Downgrade TypeScript version",
            "Usually not a TS version issue — it's a code syntax problem", 0.75,
            sources=["https://www.typescriptlang.org/docs/handbook/release-notes/overview.html"])],
        [wa("Check the line BEFORE the reported error — that's usually where the real issue is", 0.95,
            sources=["https://www.typescriptlang.org/docs/handbook/2/basic-types.html"]),
         wa("Look for unclosed brackets, parentheses, or template literals", 0.90,
            sources=["https://www.typescriptlang.org/docs/handbook/2/basic-types.html"]),
         wa("Check tsconfig.json target — some syntax requires ES2020+", 0.85,
            sources=["https://www.typescriptlang.org/tsconfig/#target"])],
    ))

    c.append(canon(
        "typescript", "ts18046-unknown-type", "ts5-linux",
        "error TS18046: 'x' is of type 'unknown'",
        r"TS18046.*is of type 'unknown'",
        "type_error", "typescript", ">=5.0,<6.0", "linux",
        "true", 0.95, 0.95,
        "Catch blocks in TS have unknown error type by default (useUnknownInCatchVariables).",
        [de("Set useUnknownInCatchVariables to false in tsconfig",
            "Disables a useful safety feature", 0.70,
            sources=["https://www.typescriptlang.org/tsconfig/#useUnknownInCatchVariables"]),
         de("Cast error to any",
            "Loses type safety — use proper narrowing instead", 0.65,
            sources=["https://www.typescriptlang.org/docs/handbook/2/narrowing.html"])],
        [wa("Narrow the type with instanceof check: if (error instanceof Error) { error.message }", 0.95,
            "catch (error) {\n  if (error instanceof Error) {\n    console.log(error.message);\n  }\n}",
            sources=["https://www.typescriptlang.org/docs/handbook/2/narrowing.html#instanceof-narrowing"]),
         wa("Use type predicate or assertion function for custom error types", 0.88,
            sources=["https://www.typescriptlang.org/docs/handbook/2/narrowing.html#using-type-predicates"])],
    ))

    # ── REACT ──────────────────────────────────────────

    c.append(canon(
        "react", "maximum-update-depth", "react18-linux",
        "Error: Maximum update depth exceeded. This can happen when a component calls setState inside useEffect without dependencies.",
        r"Maximum update depth exceeded",
        "render_error", "react", ">=18,<20", "linux",
        "true", 0.92, 0.92,
        "Infinite re-render loop. setState triggers re-render which triggers setState again.",
        [de("Add more state variables to break the loop",
            "More state = more potential for loops", 0.80,
            sources=["https://react.dev/reference/react/useState"]),
         de("Use useRef to track if already updated",
            "Hack that hides the real issue — broken effect deps", 0.65,
            sources=["https://react.dev/reference/react/useRef"])],
        [wa("Add proper dependency array to useEffect — don't include the state you're setting", 0.95,
            "useEffect(() => { setState(val); }, [dep]); // not [dep, state]",
            sources=["https://react.dev/reference/react/useEffect"]),
         wa("Move state calculation into the render (useMemo) instead of useEffect + setState", 0.90,
            sources=["https://react.dev/reference/react/useMemo"]),
         wa("Check onClick handlers: onClick={handleClick} not onClick={handleClick()}", 0.88,
            sources=["https://react.dev/learn/responding-to-events"])],
    ))

    c.append(canon(
        "react", "minified-react-error", "react18-linux",
        "Minified React error #XXX; visit https://reactjs.org/docs/error-decoder.html",
        r"Minified React error #\d+",
        "runtime_error", "react", ">=18,<20", "linux",
        "true", 0.85, 0.85,
        "Production React error with details stripped. Use error decoder URL to see full message.",
        [de("Search the error number on Google",
            "Decoder URL gives the exact message — Google results are usually generic", 0.60,
            sources=["https://react.dev/errors"]),
         de("Switch to development build in production",
            "Never ship React dev build to production — huge performance penalty", 0.90,
            sources=["https://react.dev/learn/start-a-new-react-project"])],
        [wa("Visit the error decoder URL in the error message to get the full error text", 0.95,
            "https://react.dev/errors/<number>",
            sources=["https://react.dev/errors"]),
         wa("Reproduce in development mode to get the full stack trace and error message", 0.92,
            sources=["https://react.dev/learn/start-a-new-react-project"])],
    ))

    c.append(canon(
        "react", "cannot-read-null-usecontext", "react18-linux",
        "TypeError: Cannot read properties of null (reading 'useContext')",
        r"Cannot read properties of null.*useContext|Cannot read property.*of null.*useContext",
        "hook_error", "react", ">=18,<20", "linux",
        "true", 0.90, 0.90,
        "React hooks internals are null — usually multiple React copies or calling hooks outside component.",
        [de("Downgrade React version",
            "Usually not a version issue — it's duplicate React installations", 0.75,
            sources=["https://react.dev/warnings/invalid-hook-call-warning"]),
         de("Wrap everything in a new React.createContext",
            "The issue is React internals, not your context", 0.80,
            sources=["https://react.dev/reference/react/createContext"])],
        [wa("Check for duplicate React: npm ls react — should have only one copy", 0.95,
            "npm ls react\nnpm dedupe",
            sources=["https://react.dev/warnings/invalid-hook-call-warning#duplicate-react"]),
         wa("Ensure hooks are called from a React function component, not a regular function", 0.90,
            sources=["https://react.dev/warnings/invalid-hook-call-warning"]),
         wa("If using linked packages, ensure they resolve to the same React instance", 0.85,
            sources=["https://react.dev/warnings/invalid-hook-call-warning#duplicate-react"])],
    ))

    # ── NEXT.JS ──────────────────────────────────────────

    c.append(canon(
        "nextjs", "not-found-function", "nextjs14-linux",
        "Error: NEXT_NOT_FOUND",
        r"NEXT_NOT_FOUND|notFound\(\) is not allowed",
        "routing_error", "nextjs", ">=14,<16", "linux",
        "true", 0.90, 0.90,
        "notFound() called in wrong context or not-found.tsx page missing.",
        [de("Use redirect('/404') instead",
            "Creates a redirect loop or shows wrong status code", 0.75,
            sources=["https://nextjs.org/docs/app/api-reference/functions/not-found"]),
         de("Throw a custom 404 error",
            "Next.js has built-in notFound() — custom errors bypass its handling", 0.70,
            sources=["https://nextjs.org/docs/app/api-reference/functions/not-found"])],
        [wa("Create a not-found.tsx file in the appropriate route segment", 0.95,
            "// app/not-found.tsx\nexport default function NotFound() { return <div>Not Found</div> }",
            sources=["https://nextjs.org/docs/app/api-reference/file-conventions/not-found"]),
         wa("Ensure notFound() is called in a Server Component, not a Client Component", 0.88,
            sources=["https://nextjs.org/docs/app/api-reference/functions/not-found"])],
    ))

    c.append(canon(
        "nextjs", "image-optimization-error", "nextjs14-linux",
        "Error: Invalid src prop on `next/image`",
        r"Invalid src prop.*next/image|Error:.*Image Optimization",
        "config_error", "nextjs", ">=14,<16", "linux",
        "true", 0.95, 0.95,
        "External image domain not configured in next.config.js.",
        [de("Use regular <img> tag instead",
            "Loses Next.js image optimization (lazy loading, WebP, sizing)", 0.60,
            sources=["https://nextjs.org/docs/app/api-reference/components/image"]),
         de("Set unoptimized={true} on all images",
            "Disables all optimization — defeats the purpose of next/image", 0.65,
            sources=["https://nextjs.org/docs/app/api-reference/components/image#unoptimized"])],
        [wa("Add the domain to images.remotePatterns in next.config.js", 0.95,
            "images: { remotePatterns: [{ protocol: 'https', hostname: 'example.com' }] }",
            sources=["https://nextjs.org/docs/app/api-reference/components/image#remotepatterns"]),
         wa("For local images, import them directly: import img from './image.png'", 0.90,
            sources=["https://nextjs.org/docs/app/building-your-application/optimizing/images#local-images"])],
    ))

    c.append(canon(
        "nextjs", "getserversideprops-export", "nextjs14-linux",
        "Error: 'getServerSideProps' is not supported in app/ directory",
        r"getServerSideProps.*is not supported|getServerSideProps.*app.*directory",
        "migration_error", "nextjs", ">=14,<16", "linux",
        "true", 0.92, 0.92,
        "Pages Router API used in App Router. getServerSideProps doesn't exist in app/ directory.",
        [de("Move the file back to pages/ directory",
            "Defeats the purpose of migrating to App Router", 0.60,
            sources=["https://nextjs.org/docs/app/building-your-application/upgrading/app-router-migration"]),
         de("Rename getServerSideProps to something else",
            "It's the function pattern that's unsupported, not just the name", 0.85,
            sources=["https://nextjs.org/docs/app/building-your-application/upgrading/app-router-migration"])],
        [wa("In App Router, make the component async and fetch data directly at the top level", 0.95,
            "export default async function Page() {\n  const data = await fetch('...');\n  return <div>{data}</div>;\n}",
            sources=["https://nextjs.org/docs/app/building-your-application/data-fetching"]),
         wa("Use generateMetadata for metadata and generateStaticParams for static paths", 0.88,
            sources=["https://nextjs.org/docs/app/api-reference/functions/generate-metadata"])],
    ))

    # ── DOCKER ──────────────────────────────────────────

    c.append(canon(
        "docker", "copy-failed-stat", "docker27-linux",
        "COPY failed: file not found in build context",
        r"COPY failed.*file not found|COPY failed.*stat",
        "build_error", "docker", ">=27,<28", "linux",
        "true", 0.95, 0.95,
        "COPY source file not in build context. Common cause: .dockerignore excluding the file.",
        [de("Use absolute path in COPY",
            "COPY paths are relative to build context, not host filesystem", 0.85,
            sources=["https://docs.docker.com/reference/dockerfile/#copy"]),
         de("Move Dockerfile to project root",
            "Dockerfile location doesn't change build context — that's set by docker build command", 0.70,
            sources=["https://docs.docker.com/build/concepts/context/"])],
        [wa("Check .dockerignore — it may be excluding the file you're trying to COPY", 0.95,
            "cat .dockerignore | grep <filename>",
            sources=["https://docs.docker.com/build/concepts/context/#dockerignore-files"]),
         wa("Verify the file exists relative to the build context directory (not the Dockerfile)", 0.92,
            "docker build -f Dockerfile -t app .  # '.' is the build context",
            sources=["https://docs.docker.com/reference/dockerfile/#copy"])],
    ))

    c.append(canon(
        "docker", "container-already-in-use", "docker27-linux",
        "Error response from daemon: Conflict. The container name is already in use",
        r"Conflict.*container name.*already in use",
        "runtime_error", "docker", ">=27,<28", "linux",
        "true", 0.98, 0.95,
        "Container with that name exists (running or stopped).",
        [de("Change the container name in docker-compose.yml",
            "You'll accumulate orphaned containers", 0.65,
            sources=["https://docs.docker.com/reference/cli/docker/container/run/#name"]),
         de("Use --force-recreate every time",
            "Slows down development and loses container state unnecessarily", 0.55,
            sources=["https://docs.docker.com/reference/cli/docker/compose/up/"])],
        [wa("Remove the existing container: docker rm <name> (add -f if running)", 0.95,
            "docker rm -f my_container && docker run --name my_container ...",
            sources=["https://docs.docker.com/reference/cli/docker/container/rm/"]),
         wa("Use docker-compose up which handles container lifecycle automatically", 0.92,
            sources=["https://docs.docker.com/reference/cli/docker/compose/up/"])],
    ))

    c.append(canon(
        "docker", "network-not-found", "docker27-linux",
        "Error response from daemon: network X not found",
        r"network .+ not found",
        "network_error", "docker", ">=27,<28", "linux",
        "true", 0.92, 0.92,
        "Docker network doesn't exist. Common after docker-compose down or system prune.",
        [de("Recreate with exact same subnet",
            "Usually not needed — Docker assigns subnets automatically", 0.60,
            sources=["https://docs.docker.com/reference/cli/docker/network/create/"]),
         de("Use host network mode",
            "Loses network isolation and port mapping", 0.70,
            sources=["https://docs.docker.com/engine/network/drivers/host/"])],
        [wa("Create the network: docker network create <name>", 0.95,
            "docker network create my_network",
            sources=["https://docs.docker.com/reference/cli/docker/network/create/"]),
         wa("Use docker-compose up which creates networks automatically", 0.92,
            sources=["https://docs.docker.com/reference/cli/docker/compose/up/"])],
    ))

    # ── GIT ──────────────────────────────────────────

    c.append(canon(
        "git", "src-refspec-no-match", "git2-linux",
        "error: src refspec 'main' does not match any",
        r"error: src refspec .+ does not match any",
        "push_error", "git", ">=2.30,<3.0", "linux",
        "true", 0.95, 0.95,
        "Pushing a branch that doesn't exist locally. Common: no commits yet, or wrong branch name.",
        [de("Force push",
            "Can't force push a non-existent branch — the branch literally doesn't exist", 0.90,
            sources=["https://git-scm.com/docs/git-push"]),
         de("Create empty branch with checkout --orphan",
            "Need at least one commit to push", 0.70,
            sources=["https://git-scm.com/docs/git-checkout#Documentation/git-checkout.txt---orphanltnew-branchgt"])],
        [wa("Make sure you have at least one commit: git add . && git commit -m 'initial'", 0.95,
            sources=["https://git-scm.com/docs/git-commit"]),
         wa("Check current branch name: git branch — default may be 'master' not 'main'", 0.92,
            "git branch -a",
            sources=["https://git-scm.com/docs/git-branch"])],
    ))

    c.append(canon(
        "git", "crlf-warning", "git2-linux",
        "warning: LF will be replaced by CRLF",
        r"warning: (LF will be replaced by CRLF|CRLF will be replaced by LF)",
        "config_warning", "git", ">=2.30,<3.0", "linux",
        "true", 0.95, 0.95,
        "Line ending mismatch. Harmless warning but can cause noise in diffs.",
        [de("Disable core.autocrlf entirely",
            "May cause issues when collaborating across OS platforms", 0.55,
            sources=["https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration#_core_autocrlf"]),
         de("Convert all files manually",
            "Tedious and error-prone — use .gitattributes instead", 0.65,
            sources=["https://git-scm.com/docs/gitattributes"])],
        [wa("Create .gitattributes with line ending rules for your project", 0.95,
            "* text=auto\n*.sh text eol=lf\n*.bat text eol=crlf",
            sources=["https://git-scm.com/docs/gitattributes#_end_of_line_conversion"]),
         wa("Set core.autocrlf=input on Linux/Mac or =true on Windows", 0.88,
            "git config --global core.autocrlf input",
            sources=["https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration#_core_autocrlf"])],
    ))

    c.append(canon(
        "git", "remote-already-exists", "git2-linux",
        "fatal: remote origin already exists",
        r"fatal: remote .+ already exists",
        "config_error", "git", ">=2.30,<3.0", "linux",
        "true", 0.98, 0.95,
        "Trying to add a remote that already exists.",
        [de("Delete the .git folder and reinitialize",
            "Destroys all commit history", 0.95,
            sources=["https://git-scm.com/docs/git-remote"]),
         de("Create a new remote with a different name",
            "Having two remotes for the same repo is confusing", 0.60,
            sources=["https://git-scm.com/docs/git-remote"])],
        [wa("Update existing remote URL: git remote set-url origin <new-url>", 0.98,
            "git remote set-url origin https://github.com/user/repo.git",
            sources=["https://git-scm.com/docs/git-remote#Documentation/git-remote.txt-emset-urlem"]),
         wa("Remove and re-add: git remote remove origin && git remote add origin <url>", 0.92,
            sources=["https://git-scm.com/docs/git-remote"])],
    ))

    # ── KUBERNETES ──────────────────────────────────────────

    c.append(canon(
        "kubernetes", "failedscheduling", "k8s1-linux",
        "Warning FailedScheduling: 0/N nodes are available: insufficient cpu/memory",
        r"FailedScheduling.*nodes are available.*insufficient",
        "scheduling_error", "kubernetes", ">=1.28,<2.0", "linux",
        "partial", 0.80, 0.85,
        "No nodes have enough resources for the pod. Cluster is at capacity.",
        [de("Delete other pods to free resources",
            "Those pods are running for a reason — may cause outages", 0.75,
            sources=["https://kubernetes.io/docs/concepts/scheduling-eviction/"]),
         de("Remove resource requests from the pod spec",
            "Pod may get OOMKilled without resource limits", 0.70,
            sources=["https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/"])],
        [wa("Reduce resource requests to match actual usage (check metrics first)", 0.90,
            "resources:\n  requests:\n    cpu: 100m\n    memory: 128Mi",
            sources=["https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/"]),
         wa("Scale up the cluster — add more nodes", 0.85,
            sources=["https://kubernetes.io/docs/concepts/cluster-administration/"]),
         wa("Check for node affinity/taints preventing scheduling on available nodes", 0.80,
            "kubectl describe node <node> | grep -A5 Taints",
            sources=["https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/"])],
    ))

    c.append(canon(
        "kubernetes", "forbidden-exceeded-quota", "k8s1-linux",
        "Error from server (Forbidden): error when creating: exceeded quota",
        r"Forbidden.*exceeded quota",
        "quota_error", "kubernetes", ">=1.28,<2.0", "linux",
        "partial", 0.78, 0.85,
        "Namespace resource quota exceeded. Cannot create more pods/services/etc.",
        [de("Delete the ResourceQuota object",
            "Quota exists for a reason — may be enforced by platform team", 0.80,
            sources=["https://kubernetes.io/docs/concepts/policy/resource-quotas/"]),
         de("Create resources in a different namespace",
            "May violate organizational policies", 0.65,
            sources=["https://kubernetes.io/docs/concepts/policy/resource-quotas/"])],
        [wa("Check current quota usage: kubectl describe quota -n <namespace>", 0.92,
            sources=["https://kubernetes.io/docs/concepts/policy/resource-quotas/"]),
         wa("Request quota increase from cluster admin", 0.85,
            sources=["https://kubernetes.io/docs/concepts/policy/resource-quotas/"]),
         wa("Clean up unused resources (completed jobs, old deployments)", 0.88,
            "kubectl delete jobs --field-selector status.successful=1 -n <namespace>",
            sources=["https://kubernetes.io/docs/concepts/workloads/controllers/job/"])],
    ))

    c.append(canon(
        "kubernetes", "unable-to-recognize", "k8s1-linux",
        "error: unable to recognize 'file.yaml': no matches for kind",
        r"unable to recognize.*no matches for kind",
        "api_error", "kubernetes", ">=1.28,<2.0", "linux",
        "true", 0.90, 0.90,
        "Custom resource kind not installed. CRD needs to be applied before the resource.",
        [de("Change the apiVersion to a core API group",
            "The resource IS a custom resource — it needs its own API", 0.85,
            sources=["https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/"]),
         de("Upgrade kubectl version",
            "Usually not a kubectl issue — the CRD isn't installed on the cluster", 0.70,
            sources=["https://kubernetes.io/docs/reference/kubectl/"])],
        [wa("Install the CRD first: kubectl apply -f <crd-definition>.yaml", 0.95,
            sources=["https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/"]),
         wa("Check if the operator/controller is installed that manages this CRD", 0.88,
            "kubectl get crd | grep <resource-name>",
            sources=["https://kubernetes.io/docs/concepts/extend-kubernetes/operator/"])],
    ))

    # ── CUDA ──────────────────────────────────────────

    c.append(canon(
        "cuda", "cuda-capability-error", "cuda12-rtx4090",
        "RuntimeError: CUDA error: no kernel image is available for execution on the device",
        r"no kernel image is available for execution|CUDA.*capability.*sm_\d+",
        "compatibility_error", "cuda", ">=12.0,<13.0", "linux",
        "true", 0.88, 0.90,
        "PyTorch/binary compiled for different GPU architecture. Need build matching your GPU compute capability.",
        [de("Install older CUDA toolkit",
            "CUDA toolkit version is separate from compute capability", 0.70,
            sources=["https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#compute-capabilities"]),
         de("Set CUDA_VISIBLE_DEVICES to a different GPU",
            "If all GPUs are same architecture, this won't help", 0.65,
            sources=["https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html"])],
        [wa("Install PyTorch with correct CUDA version for your GPU: check pytorch.org/get-started", 0.95,
            "pip install torch --index-url https://download.pytorch.org/whl/cu121",
            sources=["https://pytorch.org/get-started/locally/"]),
         wa("Build from source with your GPU's compute capability: TORCH_CUDA_ARCH_LIST='8.9'", 0.80,
            sources=["https://pytorch.org/docs/stable/cpp_extension.html"])],
        gpu="RTX 4090", vram=24,
    ))

    c.append(canon(
        "cuda", "torch-cuda-oom-new", "torch2-a100",
        "torch.cuda.OutOfMemoryError: CUDA out of memory",
        r"torch\.cuda\.OutOfMemoryError|CUDA out of memory",
        "oom_error", "cuda", ">=12.0,<13.0", "linux",
        "partial", 0.85, 0.90,
        "New PyTorch 2.x OOM error type. GPU memory exhausted during training or inference.",
        [de("Add torch.cuda.empty_cache() in training loop",
            "Only frees cached memory, not memory held by tensors — negligible effect", 0.75,
            sources=["https://pytorch.org/docs/stable/generated/torch.cuda.empty_cache.html"]),
         de("Set PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb",
            "Only helps with fragmentation, not actual OOM", 0.65,
            sources=["https://pytorch.org/docs/stable/notes/cuda.html#memory-management"])],
        [wa("Reduce batch size — most direct fix for OOM", 0.95,
            sources=["https://pytorch.org/docs/stable/notes/cuda.html"]),
         wa("Use gradient checkpointing to trade compute for memory", 0.88,
            "model.gradient_checkpointing_enable()",
            sources=["https://pytorch.org/docs/stable/checkpoint.html"]),
         wa("Use mixed precision training (fp16/bf16) to halve memory", 0.90,
            "scaler = torch.amp.GradScaler(); with torch.autocast('cuda'):",
            sources=["https://pytorch.org/docs/stable/amp.html"]),
         wa("Use DeepSpeed ZeRO or FSDP for multi-GPU memory distribution", 0.82,
            sources=["https://pytorch.org/docs/stable/fsdp.html"])],
        gpu="A100", vram=40,
    ))

    # ── RUST ──────────────────────────────────────────

    c.append(canon(
        "rust", "e0507-move-out-of-borrow", "rust1-linux",
        "error[E0507]: cannot move out of borrowed content",
        r"E0507.*cannot move out of",
        "ownership_error", "rust", ">=1.70,<2.0", "linux",
        "true", 0.88, 0.90,
        "Trying to take ownership of a value behind a reference. Core ownership rule violation.",
        [de("Use unsafe to bypass the borrow checker",
            "Never use unsafe to work around ownership — it will cause UB", 0.95,
            sources=["https://doc.rust-lang.org/error_codes/E0507.html"]),
         de("Make everything Copy",
            "Not all types can be Copy (String, Vec, etc.)", 0.70,
            sources=["https://doc.rust-lang.org/std/marker/trait.Copy.html"])],
        [wa("Clone the value if you need a separate copy: value.clone()", 0.90,
            sources=["https://doc.rust-lang.org/std/clone/trait.Clone.html"]),
         wa("Use .as_ref() or pattern matching with ref to avoid moving", 0.88,
            "match &my_option { Some(ref val) => { ... } }",
            sources=["https://doc.rust-lang.org/error_codes/E0507.html"]),
         wa("Consider restructuring to pass by reference instead of by value", 0.85,
            sources=["https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html"])],
    ))

    c.append(canon(
        "rust", "e0061-wrong-number-args", "rust1-linux",
        "error[E0061]: this function takes N arguments but M were supplied",
        r"E0061.*this function takes \d+ argument",
        "type_error", "rust", ">=1.70,<2.0", "linux",
        "true", 0.98, 0.95,
        "Wrong number of function arguments. Check function signature.",
        [de("Add default parameter values",
            "Rust doesn't have default parameters — use Option or builder pattern", 0.85,
            sources=["https://doc.rust-lang.org/error_codes/E0061.html"]),
         de("Use variadic arguments",
            "Rust doesn't support variadic functions (except through macros)", 0.90,
            sources=["https://doc.rust-lang.org/reference/items/functions.html"])],
        [wa("Check the function signature and match the argument count", 0.98,
            sources=["https://doc.rust-lang.org/error_codes/E0061.html"]),
         wa("If you need optional params, use Option<T> or a config struct", 0.85,
            "fn connect(host: &str, port: Option<u16>) { ... }",
            sources=["https://doc.rust-lang.org/std/option/"])],
    ))

    c.append(canon(
        "rust", "e0412-type-not-found", "rust1-linux",
        "error[E0412]: cannot find type `X` in this scope",
        r"E0412.*cannot find type",
        "type_error", "rust", ">=1.70,<2.0", "linux",
        "true", 0.95, 0.95,
        "Type not in scope. Missing use statement, typo, or missing dependency.",
        [de("Define a type alias",
            "If the type exists elsewhere, alias just adds confusion", 0.65,
            sources=["https://doc.rust-lang.org/error_codes/E0412.html"]),
         de("Use dyn Any instead",
            "Loses all type safety and requires downcasting", 0.85,
            sources=["https://doc.rust-lang.org/std/any/trait.Any.html"])],
        [wa("Add the correct use statement to import the type", 0.95,
            "use std::collections::HashMap;",
            sources=["https://doc.rust-lang.org/error_codes/E0412.html"]),
         wa("Check Cargo.toml for missing dependency if the type is from an external crate", 0.90,
            sources=["https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html"]),
         wa("Check for typos in the type name — Rust is case-sensitive", 0.88,
            sources=["https://doc.rust-lang.org/reference/items.html"])],
    ))

    # ── GO ──────────────────────────────────────────

    c.append(canon(
        "go", "panic-runtime-error", "go1-linux",
        "panic: runtime error: index out of range",
        r"panic: runtime error: index out of range",
        "runtime_error", "go", ">=1.21,<2.0", "linux",
        "true", 0.92, 0.92,
        "Array/slice index out of bounds. Go panics instead of returning error.",
        [de("Use recover() to catch all panics",
            "Silences the bug — index out of range means logic error", 0.80,
            sources=["https://go.dev/blog/defer-panic-and-recover"]),
         de("Pre-allocate a larger slice",
            "Doesn't fix the incorrect index logic", 0.70,
            sources=["https://go.dev/blog/slices-intro"])],
        [wa("Add bounds check before accessing: if i < len(slice) { ... }", 0.95,
            sources=["https://go.dev/ref/spec#Index_expressions"]),
         wa("Use range loop instead of index-based loop to avoid off-by-one", 0.90,
            "for i, v := range slice { ... }",
            sources=["https://go.dev/ref/spec#For_range"])],
    ))

    c.append(canon(
        "go", "syntax-error-unexpected", "go1-linux",
        "syntax error: unexpected token, expected ...",
        r"syntax error: unexpected",
        "syntax_error", "go", ">=1.21,<2.0", "linux",
        "true", 0.95, 0.95,
        "Go syntax error. Common causes: missing comma in multi-line args, brace on wrong line.",
        [de("Ignore and rely on gofmt",
            "gofmt can't fix syntax errors — it requires valid Go code", 0.80,
            sources=["https://pkg.go.dev/cmd/gofmt"]),
         de("Rewrite in a different style",
            "The issue is usually a specific missing token, not style", 0.70,
            sources=["https://go.dev/ref/spec"])],
        [wa("In multi-line function calls/slices, add trailing comma on last element", 0.95,
            "f(\n  arg1,\n  arg2,  // trailing comma required\n)",
            sources=["https://go.dev/ref/spec#Composite_literals"]),
         wa("Opening brace { must be on the same line as if/for/func in Go", 0.92,
            "func main() {  // correct\n// func main()\\n{  // WRONG",
            sources=["https://go.dev/doc/effective_go#semicolons"])],
    ))

    c.append(canon(
        "go", "missing-return", "go1-linux",
        "missing return at end of function",
        r"missing return at end of function",
        "compile_error", "go", ">=1.21,<2.0", "linux",
        "true", 0.98, 0.95,
        "Function declares return type but not all code paths return a value.",
        [de("Add return at the end with zero value",
            "May silently return wrong result — ensure the logic is correct", 0.55,
            sources=["https://go.dev/ref/spec#Return_statements"]),
         de("Change return type to not return anything",
            "If callers use the return value, this breaks them", 0.75,
            sources=["https://go.dev/ref/spec#Function_types"])],
        [wa("Ensure every code path (every if/else/switch branch) has a return statement", 0.95,
            sources=["https://go.dev/ref/spec#Return_statements"]),
         wa("Add a default return after the if/switch to handle the 'else' case", 0.92,
            sources=["https://go.dev/ref/spec#Return_statements"])],
    ))

    # ── PIP ──────────────────────────────────────────

    c.append(canon(
        "pip", "read-timeout-error", "pip24-linux",
        "pip._vendor.urllib3.exceptions.ReadTimeoutError: HTTPSConnectionPool",
        r"ReadTimeoutError.*HTTPSConnectionPool|pip.*ReadTimeoutError",
        "network_error", "pip", ">=24,<25", "linux",
        "partial", 0.82, 0.85,
        "PyPI download timed out. Slow network, large package, or PyPI issues.",
        [de("Install from GitHub directly",
            "GitHub is not a package registry — versions may not match PyPI", 0.65,
            sources=["https://pip.pypa.io/en/stable/cli/pip_install/"]),
         de("Disable SSL to speed up",
            "Security risk and usually doesn't help with timeouts", 0.85,
            sources=["https://pip.pypa.io/en/stable/topics/configuration/"])],
        [wa("Increase timeout: pip install --timeout 120 <package>", 0.90,
            sources=["https://pip.pypa.io/en/stable/cli/pip_install/#cmdoption-timeout"]),
         wa("Use a mirror: pip install -i https://pypi.tuna.tsinghua.edu.cn/simple <package>", 0.85,
            sources=["https://pip.pypa.io/en/stable/cli/pip_install/#cmdoption-i"]),
         wa("Retry — PyPI may have temporary issues", 0.80,
            "pip install --retries 5 <package>",
            sources=["https://pip.pypa.io/en/stable/cli/pip_install/"])],
    ))

    c.append(canon(
        "pip", "could-not-find-version", "pip24-linux",
        "ERROR: Could not find a version that satisfies the requirement X",
        r"Could not find a version that satisfies the requirement",
        "install_error", "pip", ">=24,<25", "linux",
        "true", 0.90, 0.90,
        "Package doesn't exist on PyPI, or no version matches Python/platform. Typo is #1 cause.",
        [de("Force install with --no-deps",
            "Package genuinely doesn't exist — forcing won't create it", 0.85,
            sources=["https://pip.pypa.io/en/stable/cli/pip_install/"]),
         de("Upgrade pip",
            "Rarely helps — the package name or version constraint is wrong", 0.60,
            sources=["https://pip.pypa.io/en/stable/installation/"])],
        [wa("Check for typos in the package name: pip search or pypi.org", 0.95,
            "# Common: sklearn → scikit-learn, cv2 → opencv-python",
            sources=["https://pypi.org/"]),
         wa("Check if package supports your Python version: pip install 'pkg; python_version<3.12'", 0.85,
            sources=["https://pip.pypa.io/en/stable/reference/requirement-specifiers/"]),
         wa("For platform-specific packages (e.g., Windows-only), check package docs", 0.80,
            sources=["https://pip.pypa.io/en/stable/cli/pip_install/"])],
    ))

    # ── AWS ──────────────────────────────────────────

    c.append(canon(
        "aws", "validation-exception", "awscli2-linux",
        "An error occurred (ValidationException) when calling the X operation",
        r"ValidationException.*when calling the .+ operation",
        "api_error", "aws", ">=2.0,<3.0", "linux",
        "true", 0.90, 0.90,
        "AWS API validation failed. Wrong parameter format, missing required field, or exceeds limits.",
        [de("Retry the same request",
            "Validation errors are deterministic — same request will always fail", 0.90,
            sources=["https://docs.aws.amazon.com/general/latest/gr/api-retries.html"]),
         de("Upgrade AWS CLI version",
            "Validation happens server-side — CLI version rarely matters", 0.70,
            sources=["https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html"])],
        [wa("Read the full error message — it usually tells you exactly which parameter is invalid", 0.95,
            sources=["https://docs.aws.amazon.com/general/latest/gr/error-responses.html"]),
         wa("Check AWS API docs for the specific operation's required parameters and formats", 0.90,
            sources=["https://docs.aws.amazon.com/general/latest/gr/aws-apis.html"]),
         wa("Check for parameter length/pattern limits (e.g., IAM names must be alphanumeric)", 0.85,
            sources=["https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_iam-quotas.html"])],
    ))

    c.append(canon(
        "aws", "limit-exceeded", "awscli2-linux",
        "An error occurred (LimitExceededException) when calling the X operation",
        r"LimitExceededException.*when calling the .+ operation",
        "quota_error", "aws", ">=2.0,<3.0", "linux",
        "partial", 0.75, 0.85,
        "AWS service limit reached. Each service has default limits that can be increased.",
        [de("Create a new AWS account",
            "Limits apply per-account but new accounts have LOWER limits", 0.85,
            sources=["https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html"]),
         de("Use a different region",
            "Limits are usually per-region but this isn't a real solution", 0.60,
            sources=["https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html"])],
        [wa("Request a limit increase through AWS Service Quotas console", 0.90,
            sources=["https://docs.aws.amazon.com/servicequotas/latest/userguide/request-quota-increase.html"]),
         wa("Check current usage: aws service-quotas list-service-quotas", 0.88,
            sources=["https://docs.aws.amazon.com/cli/latest/reference/service-quotas/"]),
         wa("Clean up unused resources to free capacity under the limit", 0.80,
            sources=["https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html"])],
    ))

    c.append(canon(
        "aws", "s3-access-denied", "awscli2-linux",
        "An error occurred (AccessDenied) when calling the GetObject operation: Access Denied",
        r"AccessDenied.*when calling the (Get|Put|List|Delete)Object",
        "permission_error", "aws", ">=2.0,<3.0", "linux",
        "true", 0.88, 0.90,
        "S3 bucket/object permissions deny access. Involves IAM + bucket policy + ACL + block public access.",
        [de("Make the bucket public",
            "Security risk — opens all objects to the internet", 0.90,
            sources=["https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html"]),
         de("Use root account credentials",
            "Root account should never be used for programmatic access", 0.85,
            sources=["https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html"])],
        [wa("Check IAM policy allows s3:GetObject on the specific bucket/key ARN", 0.92,
            "arn:aws:s3:::bucket-name/*",
            sources=["https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-with-s3-policy-actions.html"]),
         wa("Check bucket policy isn't explicitly denying access", 0.88,
            "aws s3api get-bucket-policy --bucket <name>",
            sources=["https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-policies.html"]),
         wa("Check S3 Block Public Access settings if accessing from external", 0.85,
            sources=["https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html"])],
    ))

    # ── TERRAFORM ──────────────────────────────────────────

    c.append(canon(
        "terraform", "unsupported-attribute", "tf1-linux",
        "Error: Unsupported attribute",
        r"Error: Unsupported attribute",
        "config_error", "terraform", ">=1.5,<2.0", "linux",
        "true", 0.92, 0.92,
        "Referencing an attribute that doesn't exist on the resource. Provider docs are the source of truth.",
        [de("Wrap in try() to ignore the error",
            "try() only works for dynamic values, not missing attributes", 0.80,
            sources=["https://developer.hashicorp.com/terraform/language/expressions/function-calls"]),
         de("Add the attribute to the resource block",
            "If the provider doesn't support it, adding it won't work", 0.75,
            sources=["https://developer.hashicorp.com/terraform/language/resources"])],
        [wa("Check the provider documentation for the correct attribute name", 0.95,
            sources=["https://registry.terraform.io/providers"]),
         wa("Run terraform providers schema to see all available attributes", 0.88,
            "terraform providers schema -json | jq '.provider_schemas'",
            sources=["https://developer.hashicorp.com/terraform/cli/commands/providers/schema"]),
         wa("Check provider version — attribute may have been added/removed in a version change", 0.85,
            sources=["https://developer.hashicorp.com/terraform/language/providers/requirements"])],
    ))

    c.append(canon(
        "terraform", "error-refreshing-state", "tf1-linux",
        "Error refreshing state: state data in S3 does not have the expected content",
        r"Error refreshing state|Error loading state",
        "state_error", "terraform", ">=1.5,<2.0", "linux",
        "partial", 0.78, 0.85,
        "Terraform state file corrupted or backend misconfigured.",
        [de("Delete the state file and re-import",
            "Deleting state loses all resource tracking — very dangerous", 0.90,
            sources=["https://developer.hashicorp.com/terraform/language/state"]),
         de("Switch to local backend temporarily",
            "Creates state divergence between local and remote", 0.70,
            sources=["https://developer.hashicorp.com/terraform/language/backend"])],
        [wa("Check S3 bucket permissions and backend configuration in terraform block", 0.90,
            sources=["https://developer.hashicorp.com/terraform/language/backend/s3"]),
         wa("If state is corrupted, pull the state file, fix it, and push back", 0.80,
            "terraform state pull > state.json\n# fix the JSON\nterraform state push state.json",
            sources=["https://developer.hashicorp.com/terraform/cli/commands/state/pull"]),
         wa("Check for concurrent terraform operations that may have corrupted state", 0.85,
            sources=["https://developer.hashicorp.com/terraform/language/state/locking"])],
    ))

    return c


def main():
    canons = get_all_canons()
    written = 0
    skipped = 0
    for c in canons:
        domain = c["error"]["domain"]
        slug = c["id"].split("/")[1]
        env = c["id"].split("/")[2]
        out_dir = DATA_DIR / domain
        out_dir.mkdir(parents=True, exist_ok=True)
        out_file = out_dir / f"{slug}_{env}.json"
        if out_file.exists():
            skipped += 1
            continue
        with open(out_file, "w", encoding="utf-8") as f:
            json.dump(c, f, indent=2, ensure_ascii=False)
            f.write("\n")
        written += 1
    print(f"Wave 4: wrote {written} new canons, skipped {skipped} existing")


if __name__ == "__main__":
    main()
